<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Atify</title>

    <link rel="icon" type="image/png" href="atify_logo.png">

    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }

        body {
            margin: 0;
            color: #e5e7eb;
            background:
                radial-gradient(circle at 20% 20%, rgba(90, 255, 120, 0.25), transparent 60%),
                radial-gradient(circle at 80% 30%, rgba(0, 200, 80, 0.2), transparent 55%),
                radial-gradient(circle at 40% 80%, rgba(0, 150, 70, 0.15), transparent 60%),
                linear-gradient(160deg, #000000 0%, #030712 40%, #020814 100%);
            background-attachment: fixed;
        }

        header {
            background: #020617;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #111827;
        }
        header h1 {
            font-size: 18px;
            margin: 0;
        }
        nav button {
            margin-right: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: none;
            background: #111827;
            color: #e5e7eb;
            cursor: pointer;
            font-size: 13px;
        }
        nav button.active {
            background: #22c55e;
            color: #022c22;
            font-weight: 600;
        }
        #userInfo {
            font-size: 12px;
            color: #9ca3af;
            text-align: right;
        }
        #userInfo b { color: #22c55e; }

        main {
            max-width: 1100px;
            margin: 16px auto 80px auto;
            padding: 16px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            border: 1px solid #1f2937;
        }

        .page { display: none; }
        .page.active { display: block; }

        h2 { margin-top: 0; font-size: 18px; }

        label {
            display: block;
            font-size: 13px;
            margin-top: 8px;
            margin-bottom: 3px;
        }
        input, textarea, select {
            width: 100%;
            padding: 7px 9px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #22c55e;
        }

        .btn {
            margin-top: 10px;
            padding: 7px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }
        .btn.primary {
            background: #22c55e;
            color: #022c22;
            font-weight: 600;
        }
        .btn.secondary {
            background: #2563eb;
            color: #eff6ff;
        }
        .btn.gray {
            background: #374151;
            color: #e5e7eb;
        }

        .muted {
            font-size: 12px;
            color: #9ca3af;
        }

        .list {
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #111827;
            background: #020617;
            font-size: 13px;
        }

        #status {
            margin-top: 12px;
            font-size: 12px;
            color: #9ca3af;
        }
        #status span.ok { color: #22c55e; }
        #status span.err { color: #f97316; }

        #popup {
            position: fixed;
            right: 20px;
            bottom: 100px;
            background: #22c55e;
            color: #022c22;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 9000;
        }

        .role-card {
            border-radius: 8px;
            border: 1px solid #1f2937;
            background: #020617;
            padding: 16px;
            flex: 1;
            min-width: 260px;
        }
        .role-title {
            font-size: 16px;
            margin-bottom: 4px;
        }
        .role-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            margin-bottom: 8px;
            color: #9ca3af;
        }

        /* ==== ≈ûARKI SAYFASI (Spotify vibe) ==== */
        .songs-layout {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 16px;
        }
        @media (max-width: 900px) {
            .songs-layout {
                grid-template-columns: 1fr;
            }
        }

        .songs-table {
            width: 100%;
            border-collapse: collapse;
        }
        .songs-header-row {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .songs-header-row th {
            padding: 6px 10px;
            font-weight: 500;
        }
        .songs-body-row {
            cursor: pointer;
            transition: background 0.1s ease;
        }
        .songs-body-row:hover {
            background: #111827;
        }
        .songs-body-row td {
            padding: 8px 10px;
            border-top: 1px solid #111827;
            font-size: 13px;
        }
        .song-title-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .song-cover {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #022c22;
            flex-shrink: 0;
        }
        .song-texts {
            display: flex;
            flex-direction: column;
        }
        .song-name {
            font-size: 13px;
        }
        .song-artist {
            font-size: 11px;
            color: #9ca3af;
        }
        .play-icon-cell {
            width: 32px;
            font-size: 14px;
            color: #9ca3af;
        }

        .songs-side-card {
            border-radius: 10px;
            border: 1px solid #111827;
            background: radial-gradient(circle at top, rgba(34,197,94,0.08), transparent 60%),
                        #020617;
            padding: 14px;
            font-size: 13px;
        }

        /* ==== PLAYLIST LAYOUT ==== */
        .playlists-layout {
            display: grid;
            grid-template-columns: 0.9fr 1.1fr;
            gap: 16px;
        }
        @media (max-width: 900px) {
            .playlists-layout {
                grid-template-columns: 1fr;
            }
        }
        .playlists-left, .playlists-right {
            background: #020617;
            border-radius: 10px;
            border: 1px solid #111827;
            padding: 12px;
        }
        .playlist-item {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            transition: background 0.1s ease;
        }
        .playlist-item:hover {
            background: #111827;
        }
        .playlist-item.active {
            background: #16a34a33;
        }
        .playlist-cover {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            color: #022c22;
            flex-shrink: 0;
        }
        .playlist-texts {
            display: flex;
            flex-direction: column;
        }
        .playlist-name {
            font-size: 13px;
        }
        .playlist-meta {
            font-size: 11px;
            color: #9ca3af;
        }

        .playlist-songs-list .item {
            padding: 6px 10px;
            border-bottom: 1px solid #111827;
        }
        .playlist-songs-list .item:last-child {
            border-bottom: none;
        }

        /* ==== BOTTOM PLAYER BAR ==== */
        .player-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #020617;
            border-top: 1px solid #111827;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            z-index: 8000;
        }
        .player-bar.hidden {
            display: none;
        }

        .player-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .player-cover {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #022c22;
            flex-shrink: 0;
        }
        .player-texts {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .player-title {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-artist {
            font-size: 11px;
            color: #9ca3af;
        }

        .player-center {
            flex: 1;
            max-width: 600px;
        }
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }
        .player-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #111827;
            color: #e5e7eb;
            font-size: 14px;
        }
        .player-btn.main {
            background: #22c55e;
            color: #022c22;
            font-size: 16px;
        }
        .player-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #9ca3af;
        }
        .progress-bar-bg {
            flex: 1;
            height: 4px;
            border-radius: 999px;
            background: #111827;
            overflow: hidden;
            cursor: pointer;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: #22c55e;
        }

        .player-right {
            font-size: 11px;
            color: #6b7280;
            min-width: 180px;
            text-align: right;
        }

        .vol-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .vol-row input[type="range"] {
            flex: 1;
            accent-color: #22c55e;
        }

        #audioPlayer {
            display: none;
        }

        /* ==== MODALLAR ==== */
        #playlistModalOverlay,
        #centerModalOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9500;
        }

        #playlistModal,
        #centerModal {
            background: #020617;
            border-radius: 12px;
            border: 1px solid #22c55e33;
            padding: 14px 16px;
            width: 260px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
            text-align: center;
        }
        .modal-title {
            font-size: 14px;
            margin-bottom: 4px;
        }
        .modal-text {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        .modal-icon {
            font-size: 26px;
            margin-bottom: 4px;
        }

        #playlistModalList {
            max-height: 200px;
            overflow: auto;
            margin-bottom: 8px;
            text-align: left;
        }
        .playlist-modal-item {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #111827;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 12px;
            background: #020617;
        }
        .playlist-modal-item:hover {
            background: #111827;
        }
        .modal-close-btn {
            margin-top: 4px;
            padding: 5px 10px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #111827;
            color: #e5e7eb;
            font-size: 12px;
        }

        /* === Artist autocomplete (≈üarkƒ± ekleme) === */
        #artistSuggestBox {
            position: relative;
        }
        #artistSuggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            background: #020617;
            border: 1px solid #111827;
            border-radius: 6px;
            max-height: 180px;
            overflow: auto;
            font-size: 12px;
            z-index: 9100;
        }
        .artist-suggestion-item {
            padding: 6px 8px;
            cursor: pointer;
        }
        .artist-suggestion-item:hover {
            background: #111827;
        }

        /* Song edit box (admin) */
        #songEditContainer {
            margin-top: 14px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #111827;
            background: #020617;
            font-size: 12px;
            display: none;
        }
        #songEditContainer h3 {
            margin-top: 0;
            font-size: 14px;
        }
    </style>
</head>
<body>

<header>
    <div id="logoArea" style="display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="goHome()">
        <img src="atify_logo.png"
             alt="Atify Logo"
             style="height:40px; border-radius:50%; box-shadow:0 0 14px rgba(34,197,94,0.7);">
        <div>
            <h1>Atify</h1>
            <div style="font-size:11px;color:#9ca3af;" id="panelLabel">Admin / Kullanƒ±cƒ± Paneli</div>
        </div>
    </div>

    <nav>
        <button data-page="home" data-role="BOTH" class="active" onclick="showPage('home', this)">Giri≈ü</button>
        <button data-page="register" data-role="BOTH" onclick="showPage('register', this)">Kayƒ±t Ol</button>
        <button data-page="songs" data-role="BOTH" onclick="showPage('songs', this)">≈ûarkƒ±lar</button>
        <button data-page="artists" data-role="ADMIN" onclick="showPage('artists', this)">Sanat√ßƒ±lar (Admin)</button>
        <button data-page="playlists" data-role="BOTH" onclick="showPage('playlists', this)">Playlistler</button>
        <button data-page="addSong" data-role="ADMIN" onclick="showPage('addSong', this)">M√ºzik Ekle (Admin)</button>
    </nav>

    <div id="userInfo">Rol se√ßilmedi</div>
</header>

<main>
    <!-- ROL SE√áƒ∞M SAYFASI -->
    <section id="page-roleSelect" class="page active">
        <h2>Atify‚Äôe Ho≈ü Geldin üéß</h2>
        <p class="muted">
            Devam etmeden √∂nce bu oturumda <b>Admin</b> mi yoksa <b>Kullanƒ±cƒ±</b> olarak mƒ± giri≈ü yapacaƒüƒ±nƒ± se√ß.
        </p>
        <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:12px;">
            <div class="role-card">
                <div class="role-badge">Admin Paneli</div>
                <div class="role-title">Admin Giri≈üi</div>
                <p class="muted">
                    ≈ûarkƒ± ekleme, sanat√ßƒ± ekleme ve t√ºm verileri y√∂netme yetkisi.
                </p>
                <button class="btn primary" onclick="enterAs('ADMIN')">Admin Olarak Devam Et</button>
            </div>
            <div class="role-card">
                <div class="role-badge">Kullanƒ±cƒ± Paneli</div>
                <div class="role-title">Kullanƒ±cƒ± Giri≈üi</div>
                <p class="muted">
                    ≈ûarkƒ±larƒ± g√∂r√ºnt√ºle, playlist olu≈ütur, playlist‚Äôe ≈üarkƒ± ekle.
                </p>
                <button class="btn secondary" onclick="enterAs('USER')">Kullanƒ±cƒ± Olarak Devam Et</button>
            </div>
        </div>
    </section>

    <!-- Gƒ∞Rƒ∞≈û SAYFASI -->
    <section id="page-home" class="page">
        <h2 id="homeTitle">Giri≈ü</h2>
        <p id="homeDesc" style="font-size:13px; color:#e5e7eb;">
            Giri≈ü yap, sonra Spotify benzeri ≈üarkƒ± ve playlist ekranlarƒ±na ge√ß.
        </p>

        <div id="authBox">
            <h3>Giri≈ü (POST /auth/login)</h3>
            <small>JWT kullanmak i√ßin √∂nce kayƒ±t olup giri≈ü yapman gerekiyor.</small>

            <div style="margin-top:8px; max-width:360px;">
                <label>Kullanƒ±cƒ± adƒ±</label>
                <input id="loginUsername" type="text" placeholder="username">
                <label>≈ûifre</label>
                <input id="loginPassword" type="password" placeholder="123456">
                <button class="btn secondary" onclick="login()">Giri≈ü Yap</button>
                <button class="btn gray" onclick="logout()">√áƒ±kƒ±≈ü</button>
            </div>

            <p class="muted" style="margin-top:12px;">
                Hen√ºz hesabƒ±n yoksa √ºstteki <b>Kayƒ±t Ol</b> sekmesinden yeni kullanƒ±cƒ± olu≈üturabilirsin.
            </p>
        </div>
    </section>

    <!-- KAYIT OL SAYFASI -->
    <section id="page-register" class="page">
        <h2>Kayƒ±t Ol</h2>
        <p class="muted">Buradan yeni kullanƒ±cƒ± olu≈üturup sonra giri≈ü ekranƒ±ndan login olabilirsin.</p>

        <div style="max-width:360px;">
            <label>Kullanƒ±cƒ± adƒ±</label>
            <input id="regUsername" type="text" placeholder="username">
            <label>Email (opsiyonel)</label>
            <input id="regEmail" type="email" placeholder="mail@ornek.com">
            <label>≈ûifre</label>
            <input id="regPassword" type="password" placeholder="123456">
            <button class="btn primary" onclick="register()">Kayƒ±t Ol</button>
        </div>
    </section>

    <!-- ≈ûARKILAR -->
    <section id="page-songs" class="page">
        <h2>≈ûarkƒ±lar</h2>
        <p class="muted" style="margin-bottom:8px;">
            Giri≈ü yaptƒ±ysan ≈üarkƒ±lar otomatik y√ºklenir. Satƒ±ra tƒ±kla, alttaki player‚Äôdan √ßalsƒ±n.
        </p>

        <div class="songs-layout">
            <div>
                <div class="list">
                    <table class="songs-table">
                        <thead>
                        <tr class="songs-header-row">
                            <th style="width:32px;"></th>
                            <th>Ba≈ülƒ±k</th>
                            <th>≈ûarkƒ±cƒ±</th>
                            <th style="width:60px; text-align:right;">S√ºre</th>
                        </tr>
                        </thead>
                        <tbody id="songsTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Admin i√ßin ≈üarkƒ± d√ºzenleme kutusu -->
                <div id="songEditContainer">
                    <h3>Se√ßili ≈üarkƒ±yƒ± d√ºzenle (Admin)</h3>
                    <p class="muted">
                        Bu b√∂l√ºm yalnƒ±zca admin i√ßin. Backend ≈üu an sadece POST /songs destekliyorsa,
                        PUT isteƒüi 405/404 d√∂nebilir; o kƒ±smƒ± backend‚Äôde eklemen gerekecek.
                    </p>
                    <label>≈ûarkƒ± ID (readonly)</label>
                    <input id="editSongId" type="text" readonly>

                    <label>≈ûarkƒ± adƒ±</label>
                    <input id="editSongName" type="text">

                    <label>S√ºre (saniye)</label>
                    <input id="editSongDuration" type="number">

                    <button class="btn primary" onclick="updateSong()">Kaydet (PUT /songs/{id})</button>
                </div>
            </div>

            <div class="songs-side-card">
                <div style="font-size:13px; margin-bottom:6px;">üéß Atify Player</div>
                <p class="muted">
                    ‚Ä¢ Liste otomatik gelir, satƒ±ra tƒ±klayƒ±nca alt player √ßalar. <br>
                    ‚Ä¢ üéØ ile ≈üarkƒ±nƒ±n ortasƒ±na atlayabilirsin. <br>
                    ‚Ä¢ Ses kaydƒ±rƒ±cƒ±yla sesi a√ß/kƒ±s. <br>
                    ‚Ä¢ ‚ÄúPlaylist‚Äôe ekle‚Äù tu≈üu ile hangi listeye ekleyeceƒüini se√ßersin.
                </p>
            </div>
        </div>
    </section>

    <!-- SANAT√áILAR -->
    <section id="page-artists" class="page">
        <h2>Sanat√ßƒ±lar (Admin)</h2>
        <p class="muted">Bu ekran adminlere √∂zel.</p>
        <button class="btn primary" onclick="getArtists()">Sanat√ßƒ±larƒ± Getir (GET /artists)</button>
        <div id="artistsList" class="list" style="margin-top:10px;">Hen√ºz sanat√ßƒ± √ßekilmedi.</div>

        <div id="artistAdminBox">
            <h3 style="margin-top:16px;font-size:15px;">Yeni Sanat√ßƒ± Ekle (POST /artists)</h3>
            <label>Sanat√ßƒ± Adƒ±</label>
            <input id="artistName" type="text" placeholder="Tarkan">
            <button class="btn secondary" onclick="createArtist()">Sanat√ßƒ± Ekle</button>
        </div>
    </section>

    <!-- PLAYLISTLER -->
    <section id="page-playlists" class="page">
        <h2>Playlistlerin</h2>
        <p class="muted" style="margin-bottom:8px;">
            Sol tarafta playlistlerin, saƒüda se√ßili playlistin ≈üarkƒ±larƒ±.
        </p>

        <div class="playlists-layout">
            <div class="playlists-left">
                <h3 style="font-size:14px;margin-top:0;">Yeni Playlist Olu≈ütur</h3>
                <label>Playlist adƒ±</label>
                <input id="playlistName" type="text" placeholder="Favorilerim">
                <button class="btn primary" onclick="createPlaylist()">Olu≈ütur</button>

                <h3 style="font-size:14px;margin-top:16px;">Playlistlerin</h3>
                <div id="playlistsList" class="list" style="padding:8px; max-height:260px; overflow:auto;">
                    Hen√ºz playlist yok.
                </div>
            </div>

            <div class="playlists-right">
                <h3 id="playlistDetailTitle" style="font-size:14px;margin-top:0;">Se√ßili playlist yok</h3>
                <div id="playlistContent" class="list playlist-songs-list" style="padding:8px; max-height:260px; overflow:auto;">
                    Bir playlist se√ßtiƒüinde ≈üarkƒ±lar burada g√∂z√ºkecek.
                </div>
            </div>
        </div>
    </section>

    <!-- M√úZƒ∞K EKLE -->
    <section id="page-addSong" class="page">
        <h2>M√ºzik Ekle (Admin ‚Äì POST /songs)</h2>
        <p class="muted" style="margin-top:-4px;">
            Body: <code>{ "name", "artistId", "duration", "playlistIdList" }</code>.
            Sadece <b>name</b> ve <b>artistId</b> zorunlu. ArtistId‚Äôyi artƒ±k otomatik dolduruyoruz.
        </p>

        <label>≈ûarkƒ± Adƒ± (name)</label>
        <input id="songTitle" type="text" placeholder="Kuzu Kuzu">

        <label>Sanat√ßƒ± (isim yazarak se√ß)</label>
        <div id="artistSuggestBox">
            <input id="songArtistNameInput" type="text" placeholder="Tarkan yazmaya ba≈üla...">
            <div id="artistSuggestions" style="display:none;"></div>
        </div>
        <input id="songArtistIdHidden" type="hidden">

        <label>S√ºre (duration, saniye - opsiyonel)</label>
        <input id="songDuration" type="number" placeholder="270">

        <label>Playlist ID Listesi (opsiyonel, 1,2,3)</label>
        <input id="songPlaylistIds" type="text" placeholder="">

        <button class="btn primary" onclick="createSong()">≈ûarkƒ±yƒ± Kaydet</button>
    </section>

    <div id="status">Durum: Rol se√ßmeni bekliyorum...</div>
</main>

<div id="popup"></div>

<!-- Gƒ∞ZLƒ∞ AUDIO -->
<audio id="audioPlayer"></audio>

<!-- ALT PLAYER (ba≈üta gizli) -->
<div id="playerBar" class="player-bar hidden">
    <div class="player-left">
        <div class="player-cover" id="playerCover">‚ô™</div>
        <div class="player-texts">
            <div class="player-title" id="playerTitle">≈ûu an ≈üarkƒ± se√ßilmedi</div>
            <div class="player-artist" id="playerArtist">Atify</div>
        </div>
    </div>

    <div class="player-center">
        <div class="player-controls">
            <button class="player-btn" onclick="seekRelative(-5)">‚è™</button>
            <button class="player-btn" onclick="jumpToMiddle()">üéØ</button>
            <button class="player-btn main" id="playPauseBtn" onclick="togglePlay()">‚ñ∂</button>
            <button class="player-btn" onclick="seekRelative(5)">‚è©</button>
        </div>
        <div class="player-progress">
            <span id="currentTimeLabel">0:00</span>
            <div class="progress-bar-bg" onclick="clickProgress(event)">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <span id="durationLabel">0:00</span>
        </div>
    </div>

    <div class="player-right">
        <div style="margin-bottom:2px;">Ses & Playlist</div>
        <div class="vol-row">
            <button class="player-btn" onclick="changeVolume(-0.1)">üîâ</button>
            <input
                    type="range"
                    id="volumeSlider"
                    min="0"
                    max="1"
                    step="0.01"
                    value="1"
                    oninput="onVolumeSliderChange(this.value)"
            >
            <button class="player-btn" onclick="changeVolume(0.1)">üîä</button>
        </div>
        <button
                class="player-btn"
                style="margin-top:6px; width:100%; padding:4px 8px; font-size:11px;"
                onclick="openPlaylistModalForCurrentSong()">
            + Playlist'e ekle
        </button>
        <div style="margin-top:4px;">≈ûarkƒ± √ßalarken playlistine ekleyebilirsin üé∂</div>
    </div>
</div>

<!-- PLAYLIST SE√áME MODALI -->
<div id="playlistModalOverlay">
    <div id="playlistModal">
        <div class="modal-title">Hangi playliste eklensin?</div>
        <div class="modal-text">A≈üaƒüƒ±dan bir playlist se√ß.</div>
        <div id="playlistModalList"></div>
        <button class="modal-close-btn" onclick="closePlaylistModal()">Vazge√ß</button>
    </div>
</div>

<!-- ORTA BA≈ûARILI MODALI -->
<div id="centerModalOverlay">
    <div id="centerModal">
        <div class="modal-icon">‚úÖ</div>
        <div class="modal-title" id="centerModalTitle">Ba≈üarƒ±lƒ±</div>
        <div class="modal-text" id="centerModalText">≈ûarkƒ± playlistine eklendi.</div>
    </div>
</div>

<script>
    const CONFIG = {
        baseUrl: "http://localhost:8080",
        endpoints: {
            register: "/auth/register",
            login: "/auth/login",
            songs: "/songs",
            artists: "/artists",
            playlists: "/playlists"
        }
    };

    let authToken = null;
    let loggedUsername = null;
    let currentRole = null;
    let currentSong = null;
    let isPlaying = false;

    let playlistsCache = [];
    let activePlaylistId = null;
    let pendingPlaylistSong = null;

    let songsCache = [];
    let allArtistsCache = [];

    const audio = document.getElementById("audioPlayer");
    const playerTitleEl = document.getElementById("playerTitle");
    const playerArtistEl = document.getElementById("playerArtist");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const currentTimeLabel = document.getElementById("currentTimeLabel");
    const durationLabel = document.getElementById("durationLabel");
    const progressBarFill = document.getElementById("progressBarFill");
    const volumeSlider = document.getElementById("volumeSlider");
    const playerBar = document.getElementById("playerBar");

    const playlistModalOverlay = document.getElementById("playlistModalOverlay");
    const playlistModalList = document.getElementById("playlistModalList");

    const centerModalOverlay = document.getElementById("centerModalOverlay");
    const centerModalTitle = document.getElementById("centerModalTitle");
    const centerModalText = document.getElementById("centerModalText");

    const artistSuggestionsBox = document.getElementById("artistSuggestions");
    const artistNameInput = document.getElementById("songArtistNameInput");
    const artistIdHidden = document.getElementById("songArtistIdHidden");

    function formatTime(sec) {
        if (!isFinite(sec)) return "0:00";
        sec = Math.floor(sec);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return m + ":" + (s < 10 ? "0" + s : s);
    }

    audio.volume = 1;

    audio.addEventListener("timeupdate", () => {
        currentTimeLabel.textContent = formatTime(audio.currentTime);
        durationLabel.textContent = formatTime(audio.duration || 0);
        const ratio = audio.duration ? (audio.currentTime / audio.duration) : 0;
        progressBarFill.style.width = (ratio * 100).toFixed(1) + "%";
    });

    audio.addEventListener("ended", () => {
        isPlaying = false;
        playPauseBtn.textContent = "‚ñ∂";
    });

    function togglePlay() {
        if (!currentSong || !audio.src) return;

        if (audio.paused) {
            audio.play().then(() => {
                isPlaying = true;
                playPauseBtn.textContent = "‚è∏";
            }).catch(err => {
                console.error(err);
                setStatus("≈ûarkƒ± √ßalƒ±nƒ±rken hata: " + err.message, false);
            });
        } else {
            audio.pause();
            isPlaying = false;
            playPauseBtn.textContent = "‚ñ∂";
        }
    }

    function seekRelative(deltaSec) {
        if (!audio.duration) return;
        let t = audio.currentTime + deltaSec;
        if (t < 0) t = 0;
        if (t > audio.duration) t = audio.duration;
        audio.currentTime = t;
    }

    function clickProgress(ev) {
        const bar = ev.currentTarget;
        const rect = bar.getBoundingClientRect();
        const ratio = (ev.clientX - rect.left) / rect.width;
        if (!audio.duration) return;
        audio.currentTime = ratio * audio.duration;
    }

    function jumpToMiddle() {
        if (!audio.duration) return;
        audio.currentTime = audio.duration / 2;
    }

    function changeVolume(delta) {
        let v = audio.volume + delta;
        if (v < 0) v = 0;
        if (v > 1) v = 1;
        audio.volume = v;
        volumeSlider.value = v.toFixed(2);
    }

    function onVolumeSliderChange(v) {
        const val = Number(v);
        if (Number.isFinite(val)) {
            audio.volume = val;
        }
    }

    function setStatus(msg, ok = true) {
        const el = document.getElementById("status");
        el.innerHTML = `Durum: ${ok ? '<span class="ok">'+msg+'</span>' : '<span class="err">'+msg+'</span>'}`;
    }

    function showPopup(message) {
        const p = document.getElementById("popup");
        p.textContent = message;
        p.style.display = "block";
        setTimeout(() => { p.style.display = "none"; }, 2000);
    }

    function showCenterModal(title, text) {
        centerModalTitle.textContent = title || "Bilgi";
        centerModalText.textContent = text || "";
        centerModalOverlay.style.display = "flex";
        setTimeout(() => {
            centerModalOverlay.style.display = "none";
        }, 1500);
    }

    function openPlaylistModalForCurrentSong() {
        if (!currentSong || !currentSong.id) {
            setStatus("√ñnce bir ≈üarkƒ± se√ßip √ßal.", false);
            return;
        }
        if (!playlistsCache || playlistsCache.length === 0) {
            setStatus("√ñnce bir playlist olu≈ütur.", false);
            showCenterModal("Playlist yok", "≈ûarkƒ±yƒ± eklemek i√ßin √∂nce en az bir playlist olu≈ütur.");
            return;
        }
        pendingPlaylistSong = currentSong;
        playlistModalList.innerHTML = "";

        playlistsCache.forEach(pl => {
            const div = document.createElement("div");
            div.className = "playlist-modal-item";
            const name = pl.name || "(isim yok)";
            const count = pl.songCount ?? (Array.isArray(pl.songs) ? pl.songs.length : null);
            div.innerHTML = `
                <div>${name}</div>
                <div style="font-size:11px;color:#9ca3af;">${count != null ? count + ' ≈üarkƒ±' : ''}</div>
            `;
            div.onclick = () => addSongToPlaylistFromModal(pl.id);
            playlistModalList.appendChild(div);
        });

        playlistModalOverlay.style.display = "flex";
    }

    function closePlaylistModal() {
        playlistModalOverlay.style.display = "none";
        pendingPlaylistSong = null;
    }

    // ‚úÖ Playlist'e ≈üarkƒ± ekleme (405 fixli)
    async function addSongToPlaylistFromModal(playlistId) {
        if (!pendingPlaylistSong || !pendingPlaylistSong.id) return;

        const path = `${CONFIG.endpoints.playlists}/${playlistId}/songs/${pendingPlaylistSong.id}`;

        const { status, ok, data } = await apiRequest(path, "POST", null, true);
        setStatus("Playlist‚Äôe ≈üarkƒ± ekleme sonucu: HTTP " + status, ok);
        console.log("addSongToPlaylistFromModal response:", data);

        if (ok) {
            const title =
                pendingPlaylistSong.name ||
                pendingPlaylistSong.title ||
                pendingPlaylistSong.songName ||
                "≈ûarkƒ±";
            closePlaylistModal();
            showPopup("≈ûarkƒ± playlistine eklendi");
            showCenterModal("Ba≈üarƒ±lƒ±", `"${title}" playlistine eklendi.`);
            if (Number(playlistId) === Number(activePlaylistId)) {
                loadPlaylistContent(playlistId);
            }
            loadPlaylists();
        }
    }

    function updateUserInfo() {
        const el = document.getElementById("userInfo");
        if (!currentRole) {
            el.textContent = "Rol se√ßilmedi";
            return;
        }
        const roleText = currentRole === "ADMIN" ? "Admin" : "Kullanƒ±cƒ±";
        if (authToken && loggedUsername) {
            el.innerHTML = `Rol: <b>${roleText}</b> | Giri≈ü yapan: <b>${loggedUsername}</b>`;
        } else {
            el.innerHTML = `Rol: <b>${roleText}</b> | Giri≈ü yapƒ±lmamƒ±≈ü`;
        }
    }

    function applyRoleToUI() {
        const panelLabel = document.getElementById("panelLabel");
        const homeTitle  = document.getElementById("homeTitle");
        const homeDesc   = document.getElementById("homeDesc");
        const artistRoleText = document.getElementById("artistRoleText");
        const artistAdminBox = document.getElementById("artistAdminBox");
        const songEditContainer = document.getElementById("songEditContainer");

        if (currentRole === "ADMIN") {
            panelLabel.textContent = "Admin Paneli";
            homeTitle.textContent  = "Admin Giri≈üi";
            homeDesc.textContent   = "Adminler i√ßin; ≈üarkƒ±, sanat√ßƒ± ve playlist y√∂netimi.";
            if (artistRoleText) artistRoleText.textContent = "Adminler sanat√ßƒ± ekleyebilir.";
            if (artistAdminBox) artistAdminBox.style.display = "";
            if (songEditContainer) songEditContainer.style.display = "block";
        } else if (currentRole === "USER") {
            panelLabel.textContent = "Kullanƒ±cƒ± Paneli";
            homeTitle.textContent  = "Kullanƒ±cƒ± Giri≈üi";
            homeDesc.textContent   = "≈ûarkƒ± dinleyip playlist olu≈üturabileceƒüin ekran.";
            if (artistRoleText) artistRoleText.textContent = "Kullanƒ±cƒ±lar sanat√ßƒ± ekleyemez.";
            if (artistAdminBox) artistAdminBox.style.display = "none";
            if (songEditContainer) songEditContainer.style.display = "none";
        }

        document.querySelectorAll("nav button").forEach(btn => {
            const needRole = btn.getAttribute("data-role");
            if (!needRole || needRole === "BOTH") {
                btn.style.display = "inline-block";
            } else if (needRole === "ADMIN" && currentRole !== "ADMIN") {
                btn.style.display = "none";
            } else if (needRole === "USER" && currentRole !== "USER") {
                btn.style.display = "none";
            } else {
                btn.style.display = "inline-block";
            }
        });

        updateUserInfo();
    }

    function enterAs(role) {
        currentRole = role;
        localStorage.setItem("atifyRole", role);

        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById("page-home").classList.add("active");
        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        document.querySelector('nav button[data-page="home"]').classList.add("active");
        applyRoleToUI();
        setStatus(role === "ADMIN" ? "Admin paneline ge√ßtin." : "Kullanƒ±cƒ± paneline ge√ßtin.", true);
    }

    function showPage(pageId, btn) {
        if (!currentRole) {
            setStatus("√ñnce Admin / Kullanƒ±cƒ± olarak giri≈ü tipini se√ß.", false);
            return;
        }
        if (currentRole !== "ADMIN" && (pageId === "artists" || pageId === "addSong")) {
            setStatus("Bu alan sadece admin i√ßin.", false);
            return;
        }

        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        const pageEl = document.getElementById("page-" + pageId);
        if (pageEl) pageEl.classList.add("active");

        if (btn) {
            document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        }

        if (pageId === "songs" && authToken) {
            getSongs();
        }
        if (pageId === "playlists" && authToken) {
            loadPlaylists();
        }
    }

    function goHome() {
        if (!currentRole) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById("page-roleSelect").classList.add("active");
            document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        } else {
            showPage("home", document.querySelector('nav button[data-page="home"]'));
        }
    }

    async function apiRequest(path, method = "GET", body = null, withAuth = true) {
        const url = CONFIG.baseUrl + path;
        const options = { method, headers: { "Content-Type": "application/json" } };
        if (withAuth && authToken) {
            options.headers["Authorization"] = "Bearer " + authToken;
        }
        if (body != null) {
            options.body = JSON.stringify(body);
        }
        try {
            const res = await fetch(url, options);
            const text = await res.text();
            let json;
            try { json = text ? JSON.parse(text) : null; } catch { json = text; }
            return { status: res.status, ok: res.ok, data: json };
        } catch (e) {
            setStatus("ƒ∞stek hatasƒ±: " + e.message, false);
            throw e;
        }
    }

    async function register() {
        const username = document.getElementById("regUsername").value.trim();
        const email    = document.getElementById("regEmail").value.trim();
        const password = document.getElementById("regPassword").value.trim();

        if (!username || !password) {
            setStatus("Kullanƒ±cƒ± adƒ± ve ≈üifre zorunlu", false);
            return;
        }

        const payload = { username, password, email: email || undefined };
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.register, "POST", payload, false);
        setStatus("Kayƒ±t sonucu: HTTP " + status, ok);
        console.log("register response:", data);

        if (ok) {
            showPopup("Kayƒ±t ba≈üarƒ±lƒ±");
            showCenterModal("Kayƒ±t tamamlandƒ±", "≈ûimdi Giri≈ü sayfasƒ±ndan login olabilirsin.");
        }
    }

    async function login() {
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!username || !password) {
            setStatus("Kullanƒ±cƒ± adƒ± ve ≈üifre zorunlu", false);
            return;
        }

        const payload = { username, password };
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.login, "POST", payload, false);
        setStatus("Giri≈ü sonucu: HTTP " + status, ok);
        console.log("login response:", data);

        if (ok) {
            const token = data && (data.token || data.jwt || data.jwtToken || data.accessToken);
            if (token) {
                authToken = token;
                loggedUsername = username;
                localStorage.setItem("atifyToken", token);
                localStorage.setItem("atifyUser", username);
                if (currentRole) {
                    localStorage.setItem("atifyRole", currentRole);
                }
                updateUserInfo();
                showPopup("Giri≈ü ba≈üarƒ±lƒ±");
                showPage("songs", document.querySelector('nav button[data-page="songs"]'));
                getSongs();
                loadPlaylists();
            } else {
                setStatus("Login OK ama token alanƒ± bulunamadƒ±.", false);
            }
        }
    }

    function logout() {
        authToken = null;
        loggedUsername = null;
        localStorage.removeItem("atifyToken");
        localStorage.removeItem("atifyUser");
        updateUserInfo();
        setStatus("√áƒ±kƒ±≈ü yapƒ±ldƒ±");
        showPopup("√áƒ±kƒ±≈ü yapƒ±ldƒ±");
    }

    function asArrayMaybe(data) {
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.content)) return data.content;
        if (data && Array.isArray(data.songs)) return data.songs;
        return [];
    }

    async function getSongs() {
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.songs, "GET", null, true);
        setStatus("≈ûarkƒ±lar getirildi: HTTP " + status, ok);

        const tbody = document.getElementById("songsTableBody");
        const arr = asArrayMaybe(data);
        songsCache = ok ? arr : [];

        tbody.innerHTML = "";

        if (!ok || arr.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 4;
            td.style.padding = "10px";
            td.style.fontSize = "12px";
            td.style.color = "#9ca3af";
            td.textContent = typeof data === "string" ? data : "Hi√ß ≈üarkƒ± bulunamadƒ±.";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        arr.forEach((song, index) => {
            const tr = document.createElement("tr");
            tr.className = "songs-body-row";

            const title = song.name || song.title || song.songName || "(isim yok)";
            const artistName = song.artistName || "Bilinmeyen ≈ûarkƒ±cƒ±";
            const duration = song.duration ?? 0;

            const tdPlay = document.createElement("td");
            tdPlay.className = "play-icon-cell";
            tdPlay.textContent = "‚ñ∂";

            const tdTitle = document.createElement("td");
            tdTitle.innerHTML = `
                <div class="song-title-cell">
                    <div class="song-cover">${(index+1)}</div>
                    <div class="song-texts">
                        <span class="song-name">${title}</span>
                        <span class="song-artist">${artistName}</span>
                    </div>
                </div>
            `;

            const tdArtist = document.createElement("td");
            tdArtist.textContent = artistName;

            const tdDuration = document.createElement("td");
            tdDuration.style.textAlign = "right";
            tdDuration.textContent = duration ? formatTime(duration) : "";

            tr.appendChild(tdPlay);
            tr.appendChild(tdTitle);
            tr.appendChild(tdArtist);
            tr.appendChild(tdDuration);

            tr.onclick = () => playSong(song);

            tbody.appendChild(tr);
        });
    }

    function playSong(song) {
        currentSong = song;
        const title = song.name || song.title || song.songName || "(isim yok)";
        const artist = song.artistName || "Bilinmeyen ≈ûarkƒ±cƒ±";
        const id = song.id ?? null;

        if (!id) {
            setStatus("≈ûarkƒ±nƒ±n id alanƒ± yok, dosya yolu √ºretemiyorum.", false);
            return;
        }

        const url = CONFIG.baseUrl + "/audio/" + id + ".mp3";

        playerTitleEl.textContent = title;
        playerArtistEl.textContent = artist;

        // admin ise edit kutusunu doldur
        if (currentRole === "ADMIN") {
            const editId = document.getElementById("editSongId");
            const editName = document.getElementById("editSongName");
            const editDur = document.getElementById("editSongDuration");
            if (editId && editName && editDur) {
                editId.value = id;
                editName.value = title;
                editDur.value = song.duration ?? 0;
            }
        }

        audio.src = url;
        audio.play()
            .then(() => {
                isPlaying = true;
                playPauseBtn.textContent = "‚è∏";
                setStatus("≈ûarkƒ± √ßalƒ±yor: " + title, true);
                playerBar.classList.remove("hidden"); // ilk ≈üarkƒ±da player'ƒ± g√∂ster
            })
            .catch(err => {
                console.error(err);
                setStatus("≈ûarkƒ± √ßalƒ±nƒ±rken hata: " + err.message, false);
            });
    }

    // Basit ≈üarkƒ± update (backend'de PUT yoksa hata d√∂ner)
    async function updateSong() {
        if (currentRole !== "ADMIN") {
            setStatus("≈ûarkƒ± d√ºzenleme sadece admin i√ßin.", false);
            return;
        }
        const id = document.getElementById("editSongId").value.trim();
        const name = document.getElementById("editSongName").value.trim();
        const durStr = document.getElementById("editSongDuration").value.trim();

        if (!id || !name) {
            setStatus("ID ve isim zorunlu.", false);
            return;
        }

        let duration = 0;
        if (durStr) {
            const d = Number(durStr);
            if (!Number.isNaN(d) && d >= 0) duration = d;
        }

        const payload = { name: name, duration: duration };
        const path = `${CONFIG.endpoints.songs}/${id}`;

        const { status, ok, data } = await apiRequest(path, "PUT", payload, true);
        setStatus("≈ûarkƒ± g√ºncelleme sonucu: HTTP " + status, ok);
        console.log("updateSong response:", data);

        if (ok) {
            showPopup("≈ûarkƒ± g√ºncellendi");
            getSongs();
        } else {
            // muhtemel 404/405'e bilerek a√ßƒ±klama:
            showCenterModal(
                "Backend g√ºncelleme yok",
                "Frontend PUT /songs/" + id + " √ßaƒüƒ±rdƒ± ama backend bu endpoint‚Äôi tanƒ±mƒ±yorsa 404/405 d√∂ner. Service‚Äôe update endpointi eklemen gerekiyor."
            );
        }
    }

    async function loadPlaylists() {
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.playlists, "GET", null, true);
        setStatus("Playlistler getirildi: HTTP " + status, ok);

        const arr = asArrayMaybe(data);
        playlistsCache = ok ? arr : [];
        renderPlaylistsList();
    }

    function renderPlaylistsList() {
        const listEl = document.getElementById("playlistsList");
        listEl.innerHTML = "";

        if (!playlistsCache || playlistsCache.length === 0) {
            listEl.textContent = "Hen√ºz playlist yok. √ústten bir playlist adƒ± girip olu≈üturabilirsin.";
            return;
        }

        playlistsCache.forEach(pl => {
            const div = document.createElement("div");
            div.className = "playlist-item";
            if (pl.id === activePlaylistId) div.classList.add("active");

            const name = pl.name || "(isim yok)";
            const songCount = pl.songCount ?? (Array.isArray(pl.songs) ? pl.songs.length : null);
            const firstChar = name ? name.trim().charAt(0).toUpperCase() : "P";

            div.innerHTML = `
                <div class="playlist-cover">${firstChar}</div>
                <div class="playlist-texts">
                    <span class="playlist-name">${name}</span>
                    <span class="playlist-meta">${songCount != null ? songCount + ' ≈üarkƒ±' : ''}</span>
                </div>
            `;

            div.onclick = () => selectPlaylist(pl.id);

            listEl.appendChild(div);
        });
    }

    async function selectPlaylist(id) {
        activePlaylistId = id;
        renderPlaylistsList();
        await loadPlaylistContent(id);
    }

    // GET /playlists/{id}/songs
    async function loadPlaylistContent(id) {
        if (!id && id !== 0) return;

        const path = `${CONFIG.endpoints.playlists}/${id}/songs`;
        const { status, ok, data } = await apiRequest(path, "GET", null, true);
        setStatus("Playlist i√ßeriƒüi getirildi: HTTP " + status, ok);

        const titleEl = document.getElementById("playlistDetailTitle");
        const box = document.getElementById("playlistContent");

        const plObj = playlistsCache.find(pl => Number(pl.id) === Number(id));
        const name = plObj && plObj.name ? plObj.name : "Playlist";
        titleEl.textContent = name;

        if (!ok || !data) {
            box.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
            return;
        }

        const songsArr = asArrayMaybe(data);
        if (songsArr.length === 0) {
            box.textContent = "Bu playlistte hen√ºz ≈üarkƒ± yok.";
            return;
        }

        box.innerHTML = "";
        songsArr.forEach(s => {
            const div = document.createElement("div");
            div.className = "item";
            const title =
                s.name ||
                s.title ||
                s.songName ||
                "(isim yok)";
            const artist = s.artistName || "Bilinmeyen ≈ûarkƒ±cƒ±";
            div.innerHTML = `<b>${title}</b> <span style="color:#9ca3af;font-size:11px;">‚Äì ${artist}</span>`;
            box.appendChild(div);
        });
    }

    async function createPlaylist() {
        const name = document.getElementById("playlistName").value.trim();
        if (!name) {
            setStatus("Playlist adƒ± zorunlu", false);
            return;
        }
        const payload = { name };
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.playlists, "POST", payload, true);
        setStatus("Playlist olu≈üturma sonucu: HTTP " + status, ok);
        console.log("createPlaylist response:", data);
        if (ok) {
            showPopup("Playlist olu≈üturuldu");
            document.getElementById("playlistName").value = "";
            await loadPlaylists();
        }
    }

    async function getArtists() {
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.artists, "GET", null, true);
        setStatus("Sanat√ßƒ±lar getirildi: HTTP " + status, ok);

        const list = document.getElementById("artistsList");
        const arr = asArrayMaybe(data);
        allArtistsCache = ok ? arr : allArtistsCache;

        if (!ok || arr.length === 0) {
            list.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
            return;
        }

        list.innerHTML = "";
        arr.forEach(a => {
            const div = document.createElement("div");
            div.className = "item";
            const id = a.id ?? "";
            const name = a.name || "(isim yok)";
            div.innerHTML = `<b>${name}</b> ${id !== "" ? "(#" + id + ")" : ""}`;
            list.appendChild(div);
        });
    }

    async function createArtist() {
        if (currentRole !== "ADMIN") {
            setStatus("Sanat√ßƒ± ekleme sadece admin i√ßin.", false);
            return;
        }
        const name = document.getElementById("artistName").value.trim();
        if (!name) {
            setStatus("Sanat√ßƒ± adƒ± zorunlu", false);
            return;
        }
        const payload = { name };
        const { status, ok, data } = await apiRequest(CONFIG.endpoints.artists, "POST", payload, true);
        setStatus("Sanat√ßƒ± ekleme sonucu: HTTP " + status, ok);
        console.log("createArtist response:", data);
        if (ok) {
            showPopup("Sanat√ßƒ± eklendi");
            document.getElementById("artistName").value = "";
            getArtists();
        }
    }

    // === ≈ûarkƒ± ekleme (artist autocomplete ile) ===
    async function ensureArtistsCache() {
        if (allArtistsCache.length > 0) return;
        const { ok, data } = await apiRequest(CONFIG.endpoints.artists, "GET", null, true);
        if (ok) {
            allArtistsCache = asArrayMaybe(data);
        }
    }

    artistNameInput.addEventListener("input", async () => {
        const query = artistNameInput.value.trim().toLowerCase();
        artistIdHidden.value = "";
        if (!query) {
            artistSuggestionsBox.style.display = "none";
            artistSuggestionsBox.innerHTML = "";
            return;
        }
        await ensureArtistsCache();
        const filtered = allArtistsCache.filter(a =>
            a.name && a.name.toLowerCase().includes(query)
        );
        if (filtered.length === 0) {
            artistSuggestionsBox.style.display = "none";
            artistSuggestionsBox.innerHTML = "";
            return;
        }
        artistSuggestionsBox.innerHTML = "";
        filtered.forEach(a => {
            const div = document.createElement("div");
            div.className = "artist-suggestion-item";
            div.textContent = a.name + " (id: " + a.id + ")";
            div.onclick = () => {
                artistNameInput.value = a.name;
                artistIdHidden.value = a.id;
                artistSuggestionsBox.style.display = "none";
                artistSuggestionsBox.innerHTML = "";
            };
            artistSuggestionsBox.appendChild(div);
        });
        artistSuggestionsBox.style.display = "block";
    });

    document.addEventListener("click", (e) => {
        if (!document.getElementById("artistSuggestBox").contains(e.target)) {
            artistSuggestionsBox.style.display = "none";
        }
    });

    async function createSong() {
        if (currentRole !== "ADMIN") {
            setStatus("≈ûarkƒ± ekleme sadece admin i√ßin.", false);
            return;
        }

        const title       = document.getElementById("songTitle").value.trim();
        const artistIdVal = artistIdHidden.value.trim();
        const durationStr = document.getElementById("songDuration").value.trim();
        const playlistStr = document.getElementById("songPlaylistIds").value.trim();

        if (!title || !artistIdVal) {
            setStatus("≈ûarkƒ± adƒ± ve sanat√ßƒ± se√ßimi zorunlu (√∂nerilerden se√ß).", false);
            return;
        }

        let duration = 0;
        if (durationStr) {
            const d = Number(durationStr);
            if (!Number.isNaN(d) && d >= 0) duration = d;
        }

        let playlistIdList = [];
        if (playlistStr) {
            playlistIdList = playlistStr
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0)
                .map(s => Number(s))
                .filter(n => !Number.isNaN(n));
        }

        const payload = {
            name: title,
            artistId: Number(artistIdVal),
            duration: duration,
        };
        if (playlistIdList.length > 0) {
            payload.playlistIdList = playlistIdList;
        }

        const { status, ok, data } = await apiRequest(CONFIG.endpoints.songs, "POST", payload, true);
        setStatus("≈ûarkƒ± ekleme sonucu: HTTP " + status, ok);
        console.log("createSong response:", data);
        if (ok) {
            showPopup("≈ûarkƒ± eklendi");
            document.getElementById("songTitle").value = "";
            artistNameInput.value = "";
            artistIdHidden.value = "";
            document.getElementById("songDuration").value = "";
            document.getElementById("songPlaylistIds").value = "";
            getSongs();
        }
    }

    // ==== ƒ∞lk ba≈ülatma: localStorage'dan devam etme ====
    function initFromStorage() {
        const token = localStorage.getItem("atifyToken");
        const user = localStorage.getItem("atifyUser");
        const role = localStorage.getItem("atifyRole");

        if (token && role) {
            authToken = token;
            loggedUsername = user;
            currentRole = role;
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById("page-home").classList.add("active");
            applyRoleToUI();
            const songsBtn = document.querySelector('nav button[data-page="songs"]');
            showPage("songs", songsBtn);
            getSongs();
            loadPlaylists();
            setStatus("Kaldƒ±ƒüƒ±n yerden devam ediyorsun.", true);
        } else {
            setStatus("Rol se√ßmeni bekliyorum...", true);
        }
    }

    initFromStorage();
</script>

</body>
</html>
